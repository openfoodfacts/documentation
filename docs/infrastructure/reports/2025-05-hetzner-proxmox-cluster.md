# 2025-05 hetzner proxmox cluster

We have setup proxmox servers (see [2025-02-18 more hetzner server install](./2025-02-18-more-hetzner-server-install.md), and [2024-11-14 hetzner server install](./2024-11-14-hetzner-server-install.md)) and configure them with ansible,
but they are yet to be set as a single cluster.

## Setting up the vSwitch

We need a vSwitch to connect our servers in a private network (which is handy for a proxmox cluster).

In robot console of hetzner, I created a vSwitch with ID 4000.
I added hetzner-01,02 and 03 servers.

I then follow [documentation](https://docs.hetzner.com/robot/dedicated-server/network/vswitch/#server-configuration-linux) to add interfaces to our servers.


### Setting up networking (obsolete)


> IMPORTANT: this is not the right way to do it, because Proxmox won't see the setup.
> See [Setting up networking in proxmox] bellow for the right way.

I created the `hetzner_vswitch` role to configure corresponding interfaces on our servers.

For example on hetzner-01, it will create `/etc/network/interfaces.d/vswitch-4000` with:

```conf
# This is generated by ansible
# Do not edit directly

# Setup inet interface for vswitch of id 4000
iface enp41s0.4000 inet manual
    vlan-raw-device enp41s0
# Setup the inet corresponding bridge
auto vmbr1
iface vmbr1 inet static
    address 10.12.0.1/16
    bridge-ports enp41s0.4000
    bridge-stp off
    bridge-fd 0
# Setup inet6 interface for vswitch of id 4000
iface enp41s0.4000 inet6 manual
    vlan-raw-device enp41s0
# Setup the inet6 corresponding bridge
auto vmbr1
iface vmbr1 inet6 static
    address fded:b8d9:a973:1:1::/64
    bridge-ports enp41s0.4000
    bridge-stp off
    bridge-fd 0
```

### Setting up networking in Proxmox

For Proxmox to see the network we need to set it up in the Proxmox UI (or using pvesh, but that's more complicated).

For this go to the Proxmox UI and:
- create eno1.4000 interface
  - without any address
  - vlan id 400
- create vmbr1 bridge, with:
  IPv4/CIDR: 10.12.0.1/16
  IPv6/CIDR: fded:b8d9:a973:1:1::/64
  Bridge ports: eno1.4000
  Comment: Internal network
- click on "Apply configuration"

You can test it's working by using some ping on other hosts.
